<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
</head>
<body style="margin: 0; height: 100vh">
    <div id="container" style="position: relative; width: 100%; height: 100%">
        <video autoplay="true" id="videoElement" style="width: 100%; height: 100%; object-fit: cover;">
        
        </video>
        <button onclick="take_photo()" class="position-absolute bottom-0 start-50 translate-middle-x mb-4
            btn btn-primary btn-lg w-50 py-3">Take photo</button>
        <div class="dropdown-left">
            <a class="position-absolute top-0 end-0 m-4 btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-arrow-down-circle-fill"></i> Download
            </a>
            <ul class="dropdown-menu" style="min-width: 136px">
              <li><a class="dropdown-item" href="ply_viewer.html">.ply</a></li>
              <li><a class="dropdown-item" onclick="downlaod_mvs()">.mvs</a></li>
              <li><a class="dropdown-item" onclick="download_ptam()">PTAM</a></li>
            </ul>
          </div>
        <a class="position-absolute top-0 start-0 m-4 fs-1" onclick="restart_reconstruction()"><i class="bi bi-trash-fill"></i></a>
    </div>
    <canvas id="canvas" style="width: 100%; height: 100%" hidden></canvas>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script> // Webcam
        var video = document.querySelector("#videoElement");
        var imageCapture;

        navigator.mediaDevices.getUserMedia({ video: {facingMode: 'environment' } })
            .then(gotMedia)
            .catch(error => console.error('getUserMedia() error:', error));

        function gotMedia(mediaStream) {
            video.srcObject = mediaStream; 
            const mediaStreamTrack = mediaStream.getVideoTracks()[0];
            imageCapture = new ImageCapture(mediaStreamTrack);
        }

        function take_photo() {
            imageCapture.takePhoto()
            .then(blob => {
                var data = new FormData();
                data.append('image', blob);
                
                let uuid = localStorage.getItem('uuid');
                if (uuid == null) {
                    $.ajax({
                        type: "POST",
                        url: "http://192.168.0.111:5000/init",
                        data: data,
                        processData: false,
                        contentType: false,
                        success: function(res) {
                            localStorage.setItem('uuid', res);
                        }
                    });
                }
                else {
                    $.ajax({
                        type: "POST",
                        url: "http://192.168.0.111:5000/" + uuid + "/extend",
                        data: data,
                        processData: false,
                        contentType: false,
                        success: function(res) {
                            console.log('succ')
                        }
                    });
                }
            })
            .catch(error => ChromeSamples.log(error));
        }

        function restart_reconstruction() {
            localStorage.removeItem("uuid");
        }

        function downlaod_mvs() {
	        window.location.href = "http://192.168.0.111:5000/" + localStorage.getItem("uuid") + "/download_mvs";
        }

        function downlaod_ptam() {
	        window.location.href = "http://192.168.0.111:5000/" + localStorage.getItem("uuid") + "/download_ptam";
        }
    </script>
</body>
</html>